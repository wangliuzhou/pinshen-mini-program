"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var webAPI = require("../../api/app/AppService");
var globalEnum = require("../../api/GlobalEnum");
var textCache = require("./textCache/TextCache");
var textSearch = (function () {
    function textSearch() {
        this.filterType = 0;
        this.mealType = 0;
        this.naviType = 0;
        this.mealDate = 0;
        this.data = {
            keyword: "",
            inputShowed: false,
            resultList: [],
            resultError: [],
            recentList: []
        };
    }
    textSearch.prototype.onLoad = function (options) {
        webAPI.SetAuthToken(wx.getStorageSync(globalEnum.globalKey_token));
        console.log(wx.getStorageSync(globalEnum.globalKey_token));
        var title = options.title;
        this.filterType = parseInt(options.filterType);
        this.mealType = parseInt(options.mealType);
        this.naviType = parseInt(options.naviType);
        this.mealDate = parseInt(options.mealDate);
        wx.setNavigationBarTitle({
            title: "添加" + title
        });
    };
    textSearch.prototype.onShow = function () {
        if (this.data.resultList.length === 0) {
            this.getRecentList();
        }
    };
    textSearch.prototype.getRecentList = function () {
        var recentList = textCache.getAllValue();
        console.log(recentList);
        this.setData({
            recentList: recentList
        });
    };
    textSearch.prototype.showInput = function () {
        this.setData({
            inputShowed: true
        });
    };
    textSearch.prototype.clearInput = function () {
        this.setData({
            keyword: "",
            resultError: false
        });
    };
    textSearch.prototype.inputTyping = function (event) {
        this.setData({
            resultError: false,
            keyword: event.detail.value,
        });
    };
    textSearch.prototype.performSearch = function () {
        var keyword = this.data.keyword;
        var req = { query: keyword, filter_type: this.filterType, meal_type: this.mealType };
        console.log(req);
        var that = this;
        webAPI.RetrieveTextSearch(req).then(function (resp) {
            console.log(resp);
            that.setResultList(resp);
        }).catch(function (err) { return console.log(err); });
    };
    textSearch.prototype.setResultList = function (resp) {
        var results = [];
        if (resp.result_list == null) {
            this.setData({
                resultList: [],
                resultError: true
            });
        }
        else {
            for (var index in resp.result_list) {
                var item = resp.result_list[index];
                var result = {
                    foodId: item.food_id,
                    foodName: item.food_name,
                    foodType: item.food_type,
                    amount: item.amount,
                    unit: item.unit_name,
                    energy: Math.floor(item.energy / 100)
                };
                results.push(result);
            }
            this.setData({
                resultList: results,
                resultError: false
            });
        }
        console.log(this.data.resultList);
    };
    textSearch.prototype.onTextSearchResultSelect = function (event) {
        var index = event.currentTarget.dataset.textIndex;
        var foodId = this.data.resultList[index].foodId;
        var foodName = this.data.resultList[index].foodName;
        var foodType = this.data.resultList[index].foodType;
        var imageUrl = "https://dietlens-1258665547.cos.ap-shanghai.myqcloud.com/mini-app-image/defaultImage/textsearch-default-image.png";
        if (this.naviType === 0) {
            wx.showLoading({ title: "加载中...", mask: true });
            var results = [{ food_id: foodId, food_name: foodName, food_type: foodType }];
            var food = { food_id: foodId, input_type: 2, food_type: foodType, recognition_results: results };
            var foodList = [food];
            var req = { meal_id: -1, meal_type: this.mealType, meal_date: this.mealDate, food_list: foodList };
            webAPI.CreateOrUpdateMealLog(req).then(function (resp) {
                wx.hideLoading({});
                var param = {};
                param.mealId = resp.meal_id;
                param.imageUrl = imageUrl;
                param.showShareBtn = false;
                var paramJson = JSON.stringify(param);
                wx.navigateTo({
                    url: "/pages/foodDetail/index?paramJson=" + paramJson
                });
            }).catch(function (err) {
                console.log(err);
                wx.hideLoading({});
            });
        }
        else {
            var pages = getCurrentPages();
            var prevPage = pages[pages.length - 2];
            prevPage.textSearchFood = { food_id: foodId, food_name: foodName, food_type: foodType };
            wx.navigateBack({
                delta: 1
            });
        }
        textCache.setValue(this.data.resultList[index]);
    };
    textSearch.prototype.onRecentResultSelect = function (event) {
        var index = event.currentTarget.dataset.textIndex;
        var foodId = this.data.recentList[index].foodId;
        var foodName = this.data.recentList[index].foodName;
        var foodType = this.data.recentList[index].foodType;
        var imageUrl = "https://dietlens-1258665547.cos.ap-shanghai.myqcloud.com/mini-app-image/defaultImage/textsearch-default-image.png";
        if (this.naviType === 0) {
            wx.showLoading({ title: "加载中...", mask: true });
            var results = [{ food_id: foodId, food_name: foodName, food_type: foodType }];
            var food = { food_id: foodId, input_type: 2, food_type: foodType, recognition_results: results };
            var foodList = [food];
            var req = { meal_id: -1, meal_type: this.mealType, meal_date: this.mealDate, food_list: foodList };
            webAPI.CreateOrUpdateMealLog(req).then(function (resp) {
                wx.hideLoading({});
                var param = {};
                param.mealId = resp.meal_id;
                param.imageUrl = imageUrl;
                param.showShareBtn = false;
                var paramJson = JSON.stringify(param);
                wx.navigateTo({
                    url: "/pages/foodDetail/index?paramJson=" + paramJson
                });
            }).catch(function (err) {
                console.log(err);
                wx.hideLoading({});
            });
        }
        else {
            var pages = getCurrentPages();
            var prevPage = pages[pages.length - 2];
            prevPage.textSearchFood = { food_id: foodId, food_name: foodName, food_type: foodType };
            wx.navigateBack({
                delta: 1
            });
        }
        textCache.setValue(this.data.recentList[index]);
    };
    textSearch.prototype.deleteTextSearchCache = function (event) {
        textCache.clearAll();
        this.getRecentList();
    };
    return textSearch;
}());
Page(new textSearch());
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLGlEQUFtRDtBQUVuRCxpREFBa0Q7QUFDbEQsaURBQWtEO0FBY2xEO0lBQUE7UUFDUyxlQUFVLEdBQUcsQ0FBQyxDQUFDO1FBQ2YsYUFBUSxHQUFHLENBQUMsQ0FBQztRQUNiLGFBQVEsR0FBRyxDQUFDLENBQUM7UUFDYixhQUFRLEdBQUcsQ0FBQyxDQUFDO1FBRWIsU0FBSSxHQUFHO1lBQ1osT0FBTyxFQUFFLEVBQUU7WUFDWCxXQUFXLEVBQUUsS0FBSztZQUNsQixVQUFVLEVBQUUsRUFBRTtZQUNkLFdBQVcsRUFBRSxFQUFFO1lBQ2YsVUFBVSxFQUFFLEVBQUU7U0FDZixDQUFBO0lBeUxILENBQUM7SUF2TFEsMkJBQU0sR0FBYixVQUFjLE9BQVk7UUFDeEIsTUFBTSxDQUFDLFlBQVksQ0FBQyxFQUFFLENBQUMsY0FBYyxDQUFDLFVBQVUsQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDO1FBQ25FLE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLGNBQWMsQ0FBQyxVQUFVLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQztRQUUzRCxJQUFJLEtBQUssR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDO1FBQzFCLElBQUksQ0FBQyxVQUFVLEdBQUcsUUFBUSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUMvQyxJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDM0MsSUFBSSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQzNDLElBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUMzQyxFQUFFLENBQUMscUJBQXFCLENBQUM7WUFDdkIsS0FBSyxFQUFFLElBQUksR0FBRyxL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LElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7SUFDbEQsQ0FBQztJQUVNLDBDQUFxQixHQUE1QixVQUE2QixLQUFVO1FBQ3JDLFNBQVMsQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUNyQixJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7SUFDdkIsQ0FBQztJQUVILGlCQUFDO0FBQUQsQ0FBQyxBQXJNRCxJQXFNQztBQUVELElBQUksQ0FBQyxJQUFJLFVBQVUsRUFBRSxDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyB3ZWJBUEkgZnJvbSAnLi4vLi4vYXBpL2FwcC9BcHBTZXJ2aWNlJztcbmltcG9ydCB7IFJldHJpZXZlVGV4dFNlYXJjaFJlcSwgUmV0cmlldmVUZXh0U2VhcmNoUmVzcCwgQ3JlYXRlT3JVcGRhdGVNZWFsTG9nUmVxLCBBZGRSZWNpcGVJdGVtUmVxLCBNZWFsTG9nUmVzcCB9IGZyb20gXCIvYXBpL2FwcC9BcHBTZXJ2aWNlT2Jqc1wiXG5pbXBvcnQgKiBhcyBnbG9iYWxFbnVtIGZyb20gJy4uLy4uL2FwaS9HbG9iYWxFbnVtJ1xuaW1wb3J0ICogYXMgdGV4dENhY2hlIGZyb20gJy4vdGV4dENhY2hlL1RleHRDYWNoZSdcblxudHlwZSBkYXRhID0ge1xuICBrZXl3b3JkOiBTdHJpbmc7XG4gIHJlc3VsdExpc3Q6IFJlc3VsdFtdO1xufVxuXG50eXBlIFJlc3VsdCA9IHtcbiAgZm9vZElkOiBudW1iZXI7XG4gIGRpc3BsYXlOYW1lOiBTdHJpbmc7XG4gIGZvb2RUeXBlOiBudW1iZXI7XG4gIGVuZ3J5OiBudW1iZXI7XG59XG5cbmNsYXNzIHRleHRTZWFyY2gge1xuICBwdWJsaWMgZmlsdGVyVHlwZSA9IDA7IC8vMC5hbGwgMS5yZWNpcGUgMi5pbmdyZWlkZW50XG4gIHB1YmxpYyBtZWFsVHlwZSA9IDA7IC8vMS5icmVha2Zhc3QgMi5sdW5jaCAzLmRpbm5lciA0LnNuYWNrXG4gIHB1YmxpYyBuYXZpVHlwZSA9IDA7IC8vMC50ZXh0c2VhcmNoID0+IGRldGFpbCAxLnRleHRzZWFyY2ggPT4gdGFnIDIudGV4dHNlYXJjaD0+IGluZ3JlZGllbnRcbiAgcHVibGljIG1lYWxEYXRlID0gMDsgLy9wcmV2IHBhZ2UgbXVzdCBwYXNzIG1lYWxEYXRlIHRvIHRleHRTZWFyY2ggcGFnZVxuXG4gIHB1YmxpYyBkYXRhID0ge1xuICAgIGtleXdvcmQ6IFwiXCIsXG4gICAgaW5wdXRTaG93ZWQ6IGZhbHNlLFxuICAgIHJlc3VsdExpc3Q6IFtdLFxuICAgIHJlc3VsdEVycm9yOiBbXSxcbiAgICByZWNlbnRMaXN0OiBbXVxuICB9XG5cbiAgcHVibGljIG9uTG9hZChvcHRpb25zOiBhbnkpIHtcbiAgICB3ZWJBUEkuU2V0QXV0aFRva2VuKHd4LmdldFN0b3JhZ2VTeW5jKGdsb2JhbEVudW0uZ2xvYmFsS2V5X3Rva2VuKSk7XG4gICAgY29uc29sZS5sb2cod3guZ2V0U3RvcmFnZVN5bmMoZ2xvYmFsRW51bS5nbG9iYWxLZXlfdG9rZW4pKTtcbiAgICAvLyB3ZWJBUEkuU2V0QXV0aFRva2VuKFwiYmltbGticWtoNTJwYTB0YTdhc2dcIik7XG4gICAgbGV0IHRpdGxlID0gb3B0aW9ucy50aXRsZTtcbiAgICB0aGlzLmZpbHRlclR5cGUgPSBwYXJzZUludChvcHRpb25zLmZpbHRlclR5cGUpO1xuICAgIHRoaXMubWVhbFR5cGUgPSBwYXJzZUludChvcHRpb25zLm1lYWxUeXBlKTtcbiAgICB0aGlzLm5hdmlUeXBlID0gcGFyc2VJbnQob3B0aW9ucy5uYXZpVHlwZSk7XG4gICAgdGhpcy5tZWFsRGF0ZSA9IHBhcnNlSW50KG9wdGlvbnMubWVhbERhdGUpO1xuICAgIHd4LnNldE5hdmlnYXRpb25CYXJUaXRsZSh7XG4gICAgICB0aXRsZTogXCLmt7vliqBcIiArIHRpdGxlLy/pobXpnaLmoIfpopjkuLrot6/nlLHlj4LmlbBcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBvblNob3coKSB7XG4gICAgaWYgKHRoaXMuZGF0YS5yZXN1bHRMaXN0Lmxlbmd0aCA9PT0gMCl7XG4gICAgICAgdGhpcy5nZXRSZWNlbnRMaXN0KCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGdldFJlY2VudExpc3QoKXtcbiAgICBsZXQgcmVjZW50TGlzdCA9IHRleHRDYWNoZS5nZXRBbGxWYWx1ZSgpO1xuICAgIGNvbnNvbGUubG9nKHJlY2VudExpc3QpO1xuICAgICh0aGlzIGFzIGFueSkuc2V0RGF0YSh7XG4gICAgICByZWNlbnRMaXN0OiByZWNlbnRMaXN0XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgc2hvd0lucHV0KCkge1xuICAgICh0aGlzIGFzIGFueSkuc2V0RGF0YSh7XG4gICAgICBpbnB1dFNob3dlZDogdHJ1ZVxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGNsZWFySW5wdXQoKSB7XG4gICAgKHRoaXMgYXMgYW55KS5zZXREYXRhKHtcbiAgICAgIGtleXdvcmQ6IFwiXCIsXG4gICAgICByZXN1bHRFcnJvcjogZmFsc2VcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBpbnB1dFR5cGluZyhldmVudDogYW55KSB7XG4gICAgKHRoaXMgYXMgYW55KS5zZXREYXRhKHtcbiAgICAgIHJlc3VsdEVycm9yOiBmYWxzZSxcbiAgICAgIGtleXdvcmQ6IGV2ZW50LmRldGFpbC52YWx1ZSxcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBwZXJmb3JtU2VhcmNoKCkge1xuICAgIGxldCBrZXl3b3JkID0gdGhpcy5kYXRhLmtleXdvcmQ7XG4gICAgbGV0IHJlcSA9IHsgcXVlcnk6IGtleXdvcmQsIGZpbHRlcl90eXBlOiB0aGlzLmZpbHRlclR5cGUsIG1lYWxfdHlwZTogdGhpcy5tZWFsVHlwZSB9O1xuICAgIGNvbnNvbGUubG9nKHJlcSk7XG4gICAgdmFyIHRoYXQgPSB0aGlzO1xuICAgIHdlYkFQSS5SZXRyaWV2ZVRleHRTZWFyY2gocmVxKS50aGVuKHJlc3AgPT4ge1xuICAgICAgY29uc29sZS5sb2cocmVzcCk7XG4gICAgICB0aGF0LnNldFJlc3VsdExpc3QocmVzcCk7XG4gICAgfSkuY2F0Y2goZXJyID0+IGNvbnNvbGUubG9nKGVycikpO1xuICB9XG5cbiAgcHVibGljIHNldFJlc3VsdExpc3QocmVzcDogUmV0cmlldmVUZXh0U2VhcmNoUmVzcCkge1xuICAgIGxldCByZXN1bHRzID0gW107XG5cbiAgICBpZiAocmVzcC5yZXN1bHRfbGlzdCA9PSBudWxsKSB7XG4gICAgICAodGhpcyBhcyBhbnkpLnNldERhdGEoe1xuICAgICAgICByZXN1bHRMaXN0OiBbXSxcbiAgICAgICAgcmVzdWx0RXJyb3I6IHRydWVcbiAgICAgIH0pXG4gICAgfSBlbHNlIHtcblxuICAgICAgZm9yIChsZXQgaW5kZXggaW4gcmVzcC5yZXN1bHRfbGlzdCkge1xuICAgICAgICBsZXQgaXRlbSA9IHJlc3AucmVzdWx0X2xpc3RbaW5kZXhdO1xuICAgICAgICBsZXQgcmVzdWx0ID0ge1xuICAgICAgICAgIGZvb2RJZDogaXRlbS5mb29kX2lkLFxuICAgICAgICAgIGZvb2ROYW1lOiBpdGVtLmZvb2RfbmFtZSxcbiAgICAgICAgICBmb29kVHlwZTogaXRlbS5mb29kX3R5cGUsXG4gICAgICAgICAgYW1vdW50OiBpdGVtLmFtb3VudCxcbiAgICAgICAgICB1bml0OiBpdGVtLnVuaXRfbmFtZSxcbiAgICAgICAgICBlbmVyZ3k6IE1hdGguZmxvb3IoaXRlbS5lbmVyZ3kgLyAxMDApXG4gICAgICAgIH1cbiAgICAgICAgcmVzdWx0cy5wdXNoKHJlc3VsdCk7XG4gICAgICB9XG4gICAgICAodGhpcyBhcyBhbnkpLnNldERhdGEoe1xuICAgICAgICByZXN1bHRMaXN0OiByZXN1bHRzLFxuICAgICAgICByZXN1bHRFcnJvcjogZmFsc2VcbiAgICAgIH0pO1xuICAgIH1cblxuXG4gICAgY29uc29sZS5sb2codGhpcy5kYXRhLnJlc3VsdExpc3QpO1xuICB9XG5cbiAgLyoqXG4gICAqIHRocmVlIGNhc2VcbiAgICogMS5mb29kRGlhcnkgLT4gdGV4dHNlYXJjaCAtPiBmb29kRGV0YWlsUGFnZShyZXR1cm4gaW5ncmVkaWVudC9yZWNlaXBlKVxuICAgKiAyLmltYWdlVGFnIC0+IHRleHRzZWFyY2ggLT4gaW1hZ2VUYWcocmV0dXJuIGluZ3JlZGllbnQvcmVjZWlwZSlcbiAgICogMy5mb29kRGV0YWlsIC0+IHRleHRzZWFyY2ggLT4gZm9vZERldGFpbChyZXR1cm4gaW5ncmVkaWVudClcbiAgICogY29tbW9uIHNvbHV0aW9uOiBzZXQgcHJldlBhZ2UuZGF0YS50ZXh0U2VhcmNoSXRlbVxuICAgKi9cbiAgcHVibGljIG9uVGV4dFNlYXJjaFJlc3VsdFNlbGVjdChldmVudDogYW55KSB7XG4gICAgbGV0IGluZGV4ID0gZXZlbnQuY3VycmVudFRhcmdldC5kYXRhc2V0LnRleHRJbmRleDtcbiAgICBsZXQgZm9vZElkID0gdGhpcy5kYXRhLnJlc3VsdExpc3RbaW5kZXhdLmZvb2RJZDtcbiAgICBsZXQgZm9vZE5hbWUgPSB0aGlzLmRhdGEucmVzdWx0TGlzdFtpbmRleF0uZm9vZE5hbWU7XG4gICAgbGV0IGZvb2RUeXBlID0gdGhpcy5kYXRhLnJlc3VsdExpc3RbaW5kZXhdLmZvb2RUeXBlO1xuICAgIGxldCBpbWFnZVVybCA9IFwiaHR0cHM6Ly9kaWV0bGVucy0xMjU4NjY1NTQ3LmNvcy5hcC1zaGFuZ2hhaS5teXFjbG91ZC5jb20vbWluaS1hcHAtaW1hZ2UvZGVmYXVsdEltYWdlL3RleHRzZWFyY2gtZGVmYXVsdC1pbWFnZS5wbmdcIjtcbiAgICBpZiAodGhpcy5uYXZpVHlwZSA9PT0gMCkge1xuICAgICAgLy9jcmVhdGUgbWVhbCBoZXJlXG4gICAgICB3eC5zaG93TG9hZGluZyh7IHRpdGxlOiBcIuWKoOi9veS4rS4uLlwiLCBtYXNrOiB0cnVlIH0pO1xuICAgICAgbGV0IHJlc3VsdHMgPSBbeyBmb29kX2lkOiBmb29kSWQsIGZvb2RfbmFtZTogZm9vZE5hbWUsIGZvb2RfdHlwZTogZm9vZFR5cGUgfV07XG4gICAgICBsZXQgZm9vZCA9IHsgZm9vZF9pZDogZm9vZElkLCBpbnB1dF90eXBlOiAyLCBmb29kX3R5cGU6IGZvb2RUeXBlLCByZWNvZ25pdGlvbl9yZXN1bHRzOiByZXN1bHRzIH07XG4gICAgICBsZXQgZm9vZExpc3QgPSBbZm9vZF07XG4gICAgICBsZXQgcmVxID0geyBtZWFsX2lkOiAtMSwgbWVhbF90eXBlOiB0aGlzLm1lYWxUeXBlLCBtZWFsX2RhdGU6IHRoaXMubWVhbERhdGUsIGZvb2RfbGlzdDogZm9vZExpc3QgfTtcbiAgICAgIHdlYkFQSS5DcmVhdGVPclVwZGF0ZU1lYWxMb2cocmVxKS50aGVuKHJlc3AgPT4ge1xuICAgICAgICB3eC5oaWRlTG9hZGluZyh7fSk7XG4gICAgICAgIGxldCBwYXJhbSA9IHt9O1xuICAgICAgICBwYXJhbS5tZWFsSWQgPSByZXNwLm1lYWxfaWQ7XG4gICAgICAgIHBhcmFtLmltYWdlVXJsID0gaW1hZ2VVcmw7XG4gICAgICAgIHBhcmFtLnNob3dTaGFyZUJ0biA9IGZhbHNlO1xuICAgICAgICBsZXQgcGFyYW1Kc29uID0gSlNPTi5zdHJpbmdpZnkocGFyYW0pO1xuICAgICAgICB3eC5uYXZpZ2F0ZVRvKHtcbiAgICAgICAgICB1cmw6IFwiL3BhZ2VzL2Zvb2REZXRhaWwvaW5kZXg/cGFyYW1Kc29uPVwiICsgcGFyYW1Kc29uXG4gICAgICAgIH0pO1xuICAgICAgfSkuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgY29uc29sZS5sb2coZXJyKTtcbiAgICAgICAgd3guaGlkZUxvYWRpbmcoe30pO1xuICAgICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgbGV0IHBhZ2VzID0gZ2V0Q3VycmVudFBhZ2VzKCk7XG4gICAgICBsZXQgcHJldlBhZ2UgPSBwYWdlc1twYWdlcy5sZW5ndGggLSAyXTtcbiAgICAgIC8vc2V0IHRleHQgc2VhcmNoIHJlc3VsdCB0byBwcmV2IHBhZ2VzXG4gICAgICBwcmV2UGFnZS50ZXh0U2VhcmNoRm9vZCA9IHsgZm9vZF9pZDogZm9vZElkLCBmb29kX25hbWU6IGZvb2ROYW1lLCBmb29kX3R5cGU6IGZvb2RUeXBlIH1cbiAgICAgIHd4Lm5hdmlnYXRlQmFjayh7XG4gICAgICAgIGRlbHRhOiAxXG4gICAgICB9KVxuICAgIH1cbiAgICAvL3JlY2VudCBMUlVcbiAgICB0ZXh0Q2FjaGUuc2V0VmFsdWUodGhpcy5kYXRhLnJlc3VsdExpc3RbaW5kZXhdKTtcbiAgfVxuXG4gIHB1YmxpYyBvblJlY2VudFJlc3VsdFNlbGVjdChldmVudDogYW55KXtcbiAgICBsZXQgaW5kZXggPSBldmVudC5jdXJyZW50VGFyZ2V0LmRhdGFzZXQudGV4dEluZGV4O1xuICAgIGxldCBmb29kSWQgPSB0aGlzLmRhdGEucmVjZW50TGlzdFtpbmRleF0uZm9vZElkO1xuICAgIGxldCBmb29kTmFtZSA9IHRoaXMuZGF0YS5yZWNlbnRMaXN0W2luZGV4XS5mb29kTmFtZTtcbiAgICBsZXQgZm9vZFR5cGUgPSB0aGlzLmRhdGEucmVjZW50TGlzdFtpbmRleF0uZm9vZFR5cGU7XG4gICAgbGV0IGltYWdlVXJsID0gXCJodHRwczovL2RpZXRsZW5zLTEyNTg2NjU1NDcuY29zLmFwLXNoYW5naGFpLm15cWNsb3VkLmNvbS9taW5pLWFwcC1pbWFnZS9kZWZhdWx0SW1hZ2UvdGV4dHNlYXJjaC1kZWZhdWx0LWltYWdlLnBuZ1wiO1xuICAgIGlmICh0aGlzLm5hdmlUeXBlID09PSAwKSB7XG4gICAgICAvL2NyZWF0ZSBtZWFsIGhlcmVcbiAgICAgIHd4LnNob3dMb2FkaW5nKHsgdGl0bGU6IFwi5Yqg6L295LitLi4uXCIsIG1hc2s6IHRydWUgfSk7XG4gICAgICBsZXQgcmVzdWx0cyA9IFt7IGZvb2RfaWQ6IGZvb2RJZCwgZm9vZF9uYW1lOiBmb29kTmFtZSwgZm9vZF90eXBlOiBmb29kVHlwZSB9XTtcbiAgICAgIGxldCBmb29kID0geyBmb29kX2lkOiBmb29kSWQsIGlucHV0X3R5cGU6IDIsIGZvb2RfdHlwZTogZm9vZFR5cGUsIHJlY29nbml0aW9uX3Jlc3VsdHM6IHJlc3VsdHMgfTtcbiAgICAgIGxldCBmb29kTGlzdCA9IFtmb29kXTtcbiAgICAgIGxldCByZXEgPSB7IG1lYWxfaWQ6IC0xLCBtZWFsX3R5cGU6IHRoaXMubWVhbFR5cGUsIG1lYWxfZGF0ZTogdGhpcy5tZWFsRGF0ZSwgZm9vZF9saXN0OiBmb29kTGlzdCB9O1xuICAgICAgd2ViQVBJLkNyZWF0ZU9yVXBkYXRlTWVhbExvZyhyZXEpLnRoZW4ocmVzcCA9PiB7XG4gICAgICAgIHd4LmhpZGVMb2FkaW5nKHt9KTtcbiAgICAgICAgbGV0IHBhcmFtID0ge307XG4gICAgICAgIHBhcmFtLm1lYWxJZCA9IHJlc3AubWVhbF9pZDtcbiAgICAgICAgcGFyYW0uaW1hZ2VVcmwgPSBpbWFnZVVybDtcbiAgICAgICAgcGFyYW0uc2hvd1NoYXJlQnRuID0gZmFsc2U7XG4gICAgICAgIGxldCBwYXJhbUpzb24gPSBKU09OLnN0cmluZ2lmeShwYXJhbSk7XG4gICAgICAgIHd4Lm5hdmlnYXRlVG8oe1xuICAgICAgICAgIHVybDogXCIvcGFnZXMvZm9vZERldGFpbC9pbmRleD9wYXJhbUpzb249XCIgKyBwYXJhbUpzb25cbiAgICAgICAgfSk7XG4gICAgICB9KS5jYXRjaChlcnIgPT4ge1xuICAgICAgICBjb25zb2xlLmxvZyhlcnIpO1xuICAgICAgICB3eC5oaWRlTG9hZGluZyh7fSk7XG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgbGV0IHBhZ2VzID0gZ2V0Q3VycmVudFBhZ2VzKCk7XG4gICAgICBsZXQgcHJldlBhZ2UgPSBwYWdlc1twYWdlcy5sZW5ndGggLSAyXTtcbiAgICAgIC8vc2V0IHRleHQgc2VhcmNoIHJlc3VsdCB0byBwcmV2IHBhZ2VzXG4gICAgICBwcmV2UGFnZS50ZXh0U2VhcmNoRm9vZCA9IHsgZm9vZF9pZDogZm9vZElkLCBmb29kX25hbWU6IGZvb2ROYW1lLCBmb29kX3R5cGU6IGZvb2RUeXBlIH1cbiAgICAgIHd4Lm5hdmlnYXRlQmFjayh7XG4gICAgICAgIGRlbHRhOiAxXG4gICAgICB9KVxuICAgIH1cbiAgICAvL3JlY2VudCBMUlVcbiAgICB0ZXh0Q2FjaGUuc2V0VmFsdWUodGhpcy5kYXRhLnJlY2VudExpc3RbaW5kZXhdKTtcbiAgfVxuXG4gIHB1YmxpYyBkZWxldGVUZXh0U2VhcmNoQ2FjaGUoZXZlbnQ6IGFueSl7XG4gICAgdGV4dENhY2hlLmNsZWFyQWxsKCk7XG4gICAgdGhpcy5nZXRSZWNlbnRMaXN0KCk7XG4gIH1cblxufVxuXG5QYWdlKG5ldyB0ZXh0U2VhcmNoKCkpXG4iXX0=